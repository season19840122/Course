# Vite2 项目工程化和原理剖析

## 第1节 Vite2 插件开发实战

#### 知识点

> **兼容性注意**
>
> Vite 需要 [Node.js](https://nodejs.org/en/) 版本 >= 12.0.0。
>
> 默认的构建目标浏览器是能 [在 script 标签上支持原生 ESM](https://caniuse.com/es6-module) 和 [原生 ESM 动态导入](https://caniuse.com/es6-module-dynamic-import)。传统浏览器可以通过官方插件 [@vitejs/plugin-legacy](https://github.com/vitejs/vite/tree/main/packages/plugin-legacy) 支持 —— 查看 [构建生产版本](https://cn.vitejs.dev/guide/build.html) 章节获取更多细节。
>
> 提供开箱即用的功能：
>
> ts

**安装**

```javascript
// Vite lastest v 2.6.10 已经变成下面这句代码了
npm init vitejs/@lastest
```
**index.html**

```html
<script type="module" src="/src/main.js"></script>
```
**App.vue**

```vue
<div :class="$style.logo"> // 渲染后的 name 带 hash
/**
 * module 的好处是:
 * 选择器的优先级不会发生变化；
 * 渲染后 name 带 hash 不会冲突；
 * 模块化的 css 可以独立出去，但是命名规则遵循 App.module.css
 */
<style module>
.logo {
......
}
</style>
```

```javascript
// 导入全局 CSS 的方法
// 在入口 main.js 里导入
import 'index.css'

// 导入 Module CSS 的方法
// 需要一个模块名来引入
import classes from '@/App.module.css'

// 调用
<div :class="classes.logo">
```

使用 Postcss 插件

```javascript
// 1. 在 root 目录下新增 postcss.config.js
// 2. 安装 Autoprefixer
npm i autoprefixer -D
```

使用 Mock 数据

```JavaScript
// 线上 JSON 数据
export default defineConfig({
  server: {
    proxy: {
      "/api": {
        target: "http://jsonplaceholder.typicode.com",
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, ""),
      },
    },
  },
});

// or
// 自己模拟数据
npm install mockjs -S
npm install vite-plugin-mock -D

// vite.config.js 需要配置
// 具体可以参考 https://github.com/anncwb/vite-plugin-mock/blob/main/README.zh_CN.md
import { viteMockServe } from 'vite-plugin-mock'
plugins: [vue(), viteMockServe({})
```

**为什么快？**

- `<script type="module" src="/src/main.js"></script>` 

  浏览器直接引用 ES Module 不需要打包了

- 按需加载，无需打包 

**P.S**

```javascript
// emmet
w200+h200
// 安装完 npm 包后需要重新项目

```

**Vite 插件**

- 可以扩展 Vite 能力
- 插件的形式
  - 对象
  - 函数（可复用）

![image-20211022163133357](/Users/fin-10821/Library/Application Support/typora-user-images/image-20211022163133357.png)

- 插件开发钩子

  ![image-20211022163327970](/Users/fin-10821/Library/Application Support/typora-user-images/image-20211022163327970.png)

  


------



## 第2节 Vite原理剖析手写实现

#### 知识点

**工作原理：**

1. 在 index.html 中，浏览器利用 ES Module imports（注意：需要高版本浏览器的支持）

   ![1](/Users/Season/FindEndorphin/Study/Learn/Course/Vite2 项目工程化和原理剖析/image/1.png)

2. 预编译，第三方依赖预打包。

   ![2](/Users/Season/FindEndorphin/Study/Learn/Course/Vite2 项目工程化和原理剖析/image/2.png)

3. 分模块解析。

   ![3](/Users/Season/FindEndorphin/Study/Learn/Course/Vite2 项目工程化和原理剖析/image/3.png)

   

---

**Reference：**

[Vite](https://cn.vitejs.dev/guide/)

[Typescript](https://www.typescriptlang.org/)

[JSONPlaceholder](http://jsonplaceholder.typicode.com/)

[vite-plugin-mock](https://github.com/anncwb/vite-plugin-mock)

[Learning-Roadmap](https://frontendmasters.com/guides/learning-roadmap/)



